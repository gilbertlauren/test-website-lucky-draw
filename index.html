<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fefefoo.bite Lucky Draw</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@700&display=swap" rel="stylesheet">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script type="text/javascript">
        (function(){ emailjs.init("6FIwWnQIhV3kwtxas"); })();
    </script>

    <style>
        :root {
            --bg-dark: #131325; --accent-yellow: #ffc107; --monster-pink: #ff6b81;
            --monster-green: #7bed9f; --monster-blue: #70a1ff; --monster-purple: #a55eea;
            --text-color-dark: #333; --text-color-light: #f4f4f4;
        }
        /* Penyesuaian Responsif dan Konten */
        body {
            font-family: 'Nunito', sans-serif; background-color: var(--bg-dark);
            background-image: radial-gradient(var(--accent-yellow) 2px, transparent 2px), radial-gradient(var(--monster-purple) 2px, transparent 2px);
            background-size: 50px 50px; background-position: 0 0, 25px 25px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-height: 100vh; margin: 0; color: var(--text-color-light); overflow-x: hidden; position: relative;
        }
        .cookie-deco { position: absolute; width: min(60px, 10vw); height: min(60px, 10vw); background-color: #d28d47; border-radius: 50%; z-index: 1; animation: floatCookie 6s ease-in-out infinite; }
        .cookie-deco::before, .cookie-deco::after { content: ''; position: absolute; background-color: #5a3214; border-radius: 50%; }
        .cookie-deco::before { width: 20%; height: 20%; top: 20%; left: 30%; box-shadow: 30% 20% 0 #5a3214; }
        .cookie-deco::after { width: 16%; height: 16%; top: 60%; left: 50%; box-shadow: -25% 8% 0 #5a3214; }
        .c1 { top: 10%; left: 10%; animation-delay: 0s; } .c2 { top: 15%; right: 10%; animation-delay: 1s; transform: scale(1.2); }
        .c3 { bottom: 10%; left: 15%; animation-delay: 2s; transform: scale(0.8); } .c4 { bottom: 5%; right: 5%; animation-delay: 0.5s; }
        @keyframes floatCookie { 0%, 100% { transform: translateY(0) rotate(0deg); } 50% { transform: translateY(-20px) rotate(15deg); } }
        .container { 
            background: rgba(255, 255, 255, 0.95); padding: 2.5rem 1.5rem; border-radius: 30px; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.5); text-align: center; 
            max-width: 450px; width: 90%; border: 8px solid var(--accent-yellow); z-index: 10; 
            box-sizing: border-box; /* Penting untuk responsif */
        }
        .hello-box { background: var(--bg-dark); color: var(--accent-yellow); padding: 5px 25px; border-radius: 50px; font-family: 'Fredoka One'; font-size: 1.2rem; display: inline-block; margin-bottom: 5px; transform: rotate(-2deg); }
        h1.main-title { font-family: 'Fredoka One', cursive; color: var(--text-color-dark); font-size: clamp(1.8rem, 5vw, 2.5rem); line-height: 1; margin: 10px 0 0; text-transform: uppercase; }
        /* Tambahan untuk Nama Penulis */
        p.author { 
            font-family: 'Caveat', cursive; /* Font tulisan tangan */
            color: #ff6b81; /* Warna Monster Pink untuk pemanis */
            font-size: clamp(1.2rem, 3.5vw, 1.8rem);
            margin: 0 0 10px;
            transform: rotate(1deg);
        }
        p.subtitle { color: #555; font-weight: 700; margin-bottom: 20px; }
        input[type="email"], input[type="text"] { 
            padding: 15px; width: 90%; max-width: 350px; border: 3px solid #eee; border-radius: 50px; 
            text-align: center; font-weight: bold; font-size: 1rem; margin-bottom: 10px; transition: 0.3s; 
            color: var(--text-color-dark); box-sizing: border-box; 
        }
        input[type="email"]:focus, input[type="text"]:focus { border-color: var(--monster-blue); outline: none; }

        /* Penyesuaian Roda untuk Responsif */
        .wheel-container { position: relative; width: min(300px, 75vw); height: min(300px, 75vw); margin: 20px auto 30px; }
        .wheel { 
            width: 100%; height: 100%; border-radius: 50%; border: 12px solid #fff; position: relative; 
            transition: transform 4.5s cubic-bezier(0.25, 1, 0.5, 1); overflow: hidden; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.4); 
            background: conic-gradient(var(--monster-purple) 0deg 72deg, var(--monster-blue) 72deg 144deg, var(--monster-green) 144deg 216deg, var(--monster-pink) 216deg 288deg, #ff9f43 288deg 360deg); 
        }
        .wheel::after { content: ''; position: absolute; inset: 0; border-radius: 50%; background: repeating-conic-gradient(transparent 0deg 70.5deg, rgba(0,0,0,0.4) 70.5deg 72deg); }
        
        /* Perbaikan Label Roda agar tidak 'bocor' dan tetap di tengah segmen */
        .wheel-label { 
            position: absolute; top: 50%; left: 50%; 
            transform-origin: 0 0; 
            font-family: 'Fredoka One', cursive; color: white; 
            font-size: clamp(10px, 3vw, 15px); /* Font responsif */
            font-weight: bold; text-shadow: 1px 1px 0 rgba(0,0,0,0.4); 
            white-space: normal; /* Izinkan wrapping jika perlu */
            word-break: break-word;
            text-align: center;
            
            /* Penyesuaian Ukuran dan Posisi */
            width: 40%; /* Menggunakan lebar relatif roda */
            height: 30px; 
            display: flex; align-items: center; justify-content: center; 
            
            /* Transformasi */
            /* Mengubah translate(110px) menjadi nilai relatif 55% dari radius */
            transform: rotate(calc(var(--i) * 72deg)) translate(55%) rotate(90deg); 
            margin-left: -20%; /* Offset agar di tengah segmen */
            box-sizing: border-box; padding: 0 3px; 
        }
        .center-dot { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 50px; height: 50px; background: var(--accent-yellow); border-radius: 50%; border: 6px solid #fff; z-index: 5; box-shadow: 0 2px 10px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .center-pointer { position: absolute; top: -12px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 22px solid transparent; border-right: 22px solid transparent; border-top: 42px solid #FFC400; z-index: 9999; filter: drop-shadow(0 3px 4px rgba(0,0,0,0.45)); }
        button { background: var(--bg-dark); color: var(--accent-yellow); border: none; padding: 18px 45px; font-family: 'Fredoka One', cursive; font-size: 20px; letter-spacing: 1px; border-radius: 50px; cursor: pointer; box-shadow: 0 6px 0 #000; transition: 0.2s; text-transform: uppercase; max-width: 100%; }
        button:hover { transform: translateY(-3px); box-shadow: 0 8px 0 #000; }
        button:active { transform: translateY(2px); box-shadow: 0 2px 0 #000; }
        button:disabled { background: #888; color: #ccc; cursor: not-allowed; }
        #result { margin-top: 25px; padding: 15px; border-radius: 15px; font-weight: 800; font-size: 1.2em; color: var(--text-color-dark); display: none; }
        .win-anim { background-color: #d4edda; color: #155724; border: 3px solid #c3e6cb; animation: popIn 0.5s ease; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        @keyframes popIn { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body>
<div class="cookie-deco c1"></div><div class="cookie-deco c2"></div><div class="cookie-deco c3"></div><div class="cookie-deco c4"></div>
<div class="container">
    <div class="hello-box">hello,</div>
    <h1 class="main-title">FEFEFOO.BITE<br>LUCKY DRAW</h1>
    <p class="author">by Sonya Chintya Dewi</p>
    <p class="subtitle">Masukkan Email & Kode Unik!</p>
    <input type="email" id="userEmail" placeholder="Contoh: nama@email.com" required>
    <input type="text" id="accessCode" placeholder="Masukkan Kode (8 Digit)" required maxlength="8" style="text-transform: uppercase;">
    <div class="wheel-container">
        <div class="wheel" id="wheel">
            <span class="wheel-label" style="--i:0;">DISKON 10%</span>
            <span class="wheel-label" style="--i:1;">Rp. 10.000</span>
            <span class="wheel-label" style="--i:2;">Rp. 5.000</span>
            <span class="wheel-label" style="--i:3;">Rp. 2.000</span>
            <span class="wheel-label" style="--i:4;">Rp. 7.000</span>
            <div class="center-dot"></div>
        </div>
        <div class="center-pointer"></div>
    </div>
    <button id="spinBtn" onclick="spinWheel()">PUTAR SEKARANG!</button>
    <div id="result"></div>
</div>

<script>
    // Hadiah dan bobot (bobot lebih tinggi = peluang lebih besar)
    const weightedSegments = [
        { prize: "DISKON 10%", weight: 1 }, // Peluang terkecil (1/18)
        { prize: "Rp. 10.000", weight: 2 }, // Peluang kedua terkecil (2/18)
        { prize: "Rp. 5.000", weight: 3 }, // Peluang menengah (3/18)
        { prize: "Rp. 2.000", weight: 7 }, // Peluang terbesar (7/18)
        { prize: "Rp. 7.000", weight: 5 }  // Peluang di atas menengah (5/18)
        // Total Bobot = 1+2+3+7+5 = 18
    ];
    const segments = weightedSegments.map(s => s.prize); // Hanya nama hadiah untuk tampilan
    const segmentAngle = 360 / segments.length; // Sudut per segmen (tetap 72 derajat)
    let hasSpun = false;
    let currentRotation = 0;

    // Fungsi untuk mendapatkan segmen pemenang berdasarkan bobot (weighted random)
    function getWeightedRandomSegment() {
        let totalWeight = weightedSegments.reduce((sum, item) => sum + item.weight, 0);
        let randomNum = Math.random() * totalWeight;
        let weightSum = 0;
        
        for (let i = 0; i < weightedSegments.length; i++) {
            weightSum += weightedSegments[i].weight;
            if (randomNum <= weightSum) {
                return i; // Mengembalikan Index (0 sampai 4)
            }
        }
        return 0; // Fallback
    }

    async function spinWheel() {
        const email = document.getElementById('userEmail').value;
        const codeInput = document.getElementById('accessCode').value.trim();
        const wheel = document.getElementById('wheel');
        const resultDiv = document.getElementById('result');
        const btn = document.getElementById('spinBtn');

        if(email.length < 5 || !email.includes("@")) { alert("âš ï¸ Harap masukkan email yang valid!"); return; }
        if(!codeInput) { alert("âš ï¸ Harap masukkan kode unik!"); return; }
        if (hasSpun) { alert("â›” Anda sudah mengambil kesempatan diskon!"); return; }

        btn.disabled = true;
        btn.innerText = "Memvalidasi...";

        try {
            // --- KONEKSI KE DATABASE VERCEL ---
            const response = await fetch('/api/validate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email: email, code: codeInput })
            });
            const data = await response.json();

            // Jika validasi GAGAL (Kode salah atau sudah dipakai)
            if (!data.success) {
                alert(data.message);
                btn.disabled = false;
                btn.innerText = "PUTAR SEKARANG!";
                return;
            }

            // Jika SUKSES, Mulai Spin
            // MENGGUNAKAN FUNGSI WEIGHTED RANDOM
            const winningSegmentIndex = getWeightedRandomSegment(); 
            
            const pointerOffset = 90; // Sudut untuk mengarahkan pointer ke tengah segmen pertama (0)
            const targetCenter = (winningSegmentIndex * segmentAngle) + (segmentAngle / 2) + pointerOffset;
            const normalized = ((targetCenter % 360) + 360) % 360;
            const degreesToStopAt = 360 - normalized; // Derajat yang diperlukan agar segmen berada di bawah pointer
            const baseSpins = 6;
            const finalSpinDegrees = (baseSpins * 360) + degreesToStopAt;

            currentRotation += finalSpinDegrees;
            wheel.style.transition = "transform 4.5s cubic-bezier(0.25, 1, 0.5, 1)";
            wheel.style.transform = `rotate(${currentRotation}deg)`;
            btn.innerText = "Sedang Berputar...";

            setTimeout(() => {
                hasSpun = true;
                const winningPrize = segments[winningSegmentIndex];
                resultDiv.style.display = "block";
                resultDiv.className = "win-anim";
                resultDiv.innerHTML = `<span style="font-family:'Fredoka One'; font-size: 1.4em;">ðŸŽ‰ YAY! SELAMAT!</span><br>Kamu dapat Diskon <b style="color:#d63031; font-size: 1.3em;">${winningPrize}</b><br><small style="color:#555">Kode dikirim ke: ${email}</small>`;
                btn.innerText = "Diskon Diklaim!";

                emailjs.send('service_xkqsdbp', 'template_m8raygp', { 
                    from_email: email, prize: winningPrize, unique_code: codeInput 
                });
            }, 4500); // Penyesuaian waktu timeout agar sesuai dengan transisi CSS

        } catch (error) {
            console.error("Error during spin or validation:", error);
            alert("Terjadi kesalahan koneksi atau server. Coba lagi.");
            btn.disabled = false;
            btn.innerText = "PUTAR SEKARANG!";
        }
    }
</script>
</body>
</html>